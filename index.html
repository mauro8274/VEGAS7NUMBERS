<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEGAS 7 NUMBERS</title>
    <style>
        /* CSS per la ReattivitÃ  e lo Stile */
        :root {
            --green-bg: #4CAF50; 
            --light-gray-bg: #f0f0f0; 
            --red-btn: #f44336;
            --blue-btn: #2196F3;
            --text-color: #333;
            --border-color: #ccc;
            --light-green: #e8ffe8; 
            --win-green: #2ecc71; 
            --dark-blue: #34495e; 
            --disabled-color: #95a5a6; 
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--green-bg); 
            color: var(--text-color);
        }

        /* STILE INTESTAZIONE IMMAGINE */
        .header-image-container {
            text-align: center;
            padding: 10px 0;
            margin: 0;
        }
        .header-image-container img {
            max-width: 100%; /* Rende l'immagine responsiva */
            height: auto;
            max-height: 100px; /* Limita l'altezza per non occupare troppo spazio */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Gestione delle Pagine */
        .page-content {
            display: none; 
        }
        #main-page {
            display: block; 
        }
        
        /* Area Input Principale */
        .input-area {
            background-color: var(--light-gray-bg); 
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Campi di Input */
        .input-group {
            display: flex;
            flex-wrap: wrap; 
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group label {
            font-weight: bold;
            flex-basis: 100%; 
        }
        .input-group input[type="number"],
        .input-group .calculated-field {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            flex-grow: 1; 
            min-width: 120px; 
        }
        .input-group .calculated-field {
            background-color: white; 
            font-weight: bold;
            display: flex;
            align-items: center;
            min-height: 40px; 
        }

        /* Bottoni */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: space-around;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
            max-width: 200px; 
            transition: background-color 0.3s;
        }
        .btn-red { background-color: var(--red-btn); }
        .btn-blue { background-color: var(--blue-btn); }
        .btn:hover:not(:disabled) { opacity: 0.9; }

        .btn-archive-action { 
            background-color: var(--dark-blue);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
        }
        .btn-archive-action:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        .data-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }
        .extracted-numbers-container, .suggested-numbers-area {
            flex: 1 1 200px; 
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .suggested-numbers-area { text-align: center; }
        #numeri-suggeriti {
            font-size: 1.8em;
            color: var(--win-green); 
            margin: 10px 0 0;
            word-wrap: break-word; 
        }
        .extracted-numbers-table { width: 100%; border-collapse: collapse; }
        .extracted-numbers-table th, .extracted-numbers-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }

        .data-table-container {
            flex: 3 1 400px; 
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto; 
        }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { border: 1px solid #000; padding: 8px 5px; text-align: center; font-size: 0.9em; }
        .data-table th { background-color: #e0e0e0; }

        .evidenziato { background-color: #ffffa8 !important; color: #333; font-weight: bold; } 
        .riga-bruciata { background-color: #ff4d4d !important; color: white; font-weight: bold; } 
        .riga-bruciata td { background-color: transparent !important; color: white; }

        .progression-section {
            background-color: white;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        .progression-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        .progression-table th, .progression-table td {
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
        }
        .progression-table thead th {
            background-color: #333;
            color: white;
            font-size: 0.9em;
        }
        .header-big { background-color: #555 !important; }
        .header-medio { background-color: #e67e22 !important; }
        .header-mini { background-color: #27ae60 !important; }

        .active-step {
            background-color: var(--light-green) !important;
            font-weight: bold;
        }
        .reset-progression-btn {
            background-color: var(--dark-blue);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* STILI PAGINA STATISTICHE (RIDUZIONE FONT/PADDING) */
        #stats-page {
            background-color: var(--light-gray-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .stats-summary, .stats-sessions {
            margin-bottom: 20px;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em; 
        }
        .stats-table th, .stats-table td {
            border: 1px solid var(--border-color);
            padding: 8px; 
            text-align: center;
        }
        .stats-table th {
            background-color: #ddd;
        }
        .positive-saldo { color: var(--win-green); font-weight: bold; }
        .negative-saldo { color: var(--red-btn); font-weight: bold; }

        /* Media Query per schermi grandi */
        @media (min-width: 600px) {
            .input-group label { flex-basis: auto; margin-right: 10px; }
            .input-group { justify-content: space-between; }
            .input-group input[type="number"], .input-group .calculated-field { flex-grow: 0; width: calc(33% - 15px); }
            .action-buttons button { max-width: 200px; }
        }
    </style>
</head>
<body>

    <div class="header-image-container">
        <img src="https://raw.githubusercontent.com/mauro8274/Provavegas/81a5c6465ecb5ed1ef903dcc9d2ddeff69d04964/IMG_0628.jpeg" alt="Logo Vegas 7 Numbers">
    </div>

    <div class="container">
        
        <div id="main-page" class="page-content">
            
            <div class="input-area">
                
                <div class="input-group">
                    <label for="numero-estratto">Numero Estratto (0-36):</label>
                    <input type="number" id="numero-estratto" min="0" max="36" inputmode="numeric" pattern="[0-9]*" placeholder="Inserisci numero" autofocus>
                    
                    <label for="valore-unitario">Valore Unitario (â‚¬):</label>
                    <input type="text" id="valore-unitario" placeholder="0,10"> <label>Saldo Real Time:</label>
                    <div id="saldo-real-time" class="calculated-field">â‚¬ 0.00</div>
                </div>

                <div class="button-group">
                    <button id="reset-numeri" class="btn btn-red">Reset numeri</button>
                    <button id="visualizza-archivio" class="btn btn-blue">Visualizza archivio</button>
                </div>
                
                <div class="action-buttons">
                    <button id="archivia-saldo" class="btn-archive-action">Archivia Saldo Corrente</button>
                    <button id="richiama-ultimi" class="btn-archive-action" disabled>Richiama Ultimi 10 Numeri</button>
                </div>
            </div>
            
            <hr>

            <div class="suggested-numbers-area">
                <h3>I Numeri Suggeriti:</h3>
                <p id="numeri-suggeriti">Attendendo la Logica...</p>
            </div>

            <hr>

            <div class="progression-section">
                <h3>PROGRESSIONE PUNTATE</h3>
                <table class="progression-table">
                    <thead>
                        <tr id="progression-header">
                            <th>STEP</th>
                            <th class="header-big">BIG: <span id="big-number">?</span></th>
                            <th class="header-medio">MEDIO: <span id="medio1-number">?</span></th>
                            <th class="header-medio">MEDIO: <span id="medio2-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini1-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini2-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini3-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini4-number">?</span></th>
                        </tr>
                    </thead>
                    <tbody id="progression-body">
                        </tbody>
                </table>
                <button id="reset-progressione" class="reset-progression-btn">RESET PROGRESSIONE</button>
            </div>

            <hr>

            <div class="data-section">
                
                <div class="extracted-numbers-container">
                    <h3>Numeri Estratti</h3>
                    <table class="extracted-numbers-table">
                        <thead><tr><th>Numero</th></tr></thead>
                        <tbody id="lista-estratti"></tbody>
                    </table>
                </div>

                <div class="data-table-container">
                    <h3>TABELLA DATI</h3>
                    <table class="data-table" id="tabella-dati">
                        <tbody>
                            <tr><td>2</td><td>1</td><td>3</td><td>36</td><td>4</td><td>34</td><td>6</td></tr>
                            <tr><td>5</td><td>4</td><td>6</td><td>1</td><td>9</td><td>3</td><td>7</td></tr>
                            <tr><td>8</td><td>9</td><td>7</td><td>4</td><td>12</td><td>6</td><td>10</td></tr>
                            <tr><td>11</td><td>12</td><td>10</td><td>9</td><td>13</td><td>7</td><td>15</td></tr>
                            <tr><td>14</td><td>13</td><td>15</td><td>12</td><td>16</td><td>10</td><td>18</td></tr>
                            <tr><td>17</td><td>16</td><td>18</td><td>13</td><td>21</td><td>15</td><td>19</td></tr>
                            <tr><td>20</td><td>21</td><td>19</td><td>16</td><td>24</td><td>18</td><td>22</td></tr>
                            <tr><td>23</td><td>24</td><td>22</td><td>21</td><td>25</td><td>19</td><td>27</td></tr>
                            <tr><td>26</td><td>25</td><td>27</td><td>24</td><td>28</td><td>22</td><td>30</td></tr>
                            <tr><td>29</td><td>28</td><td>30</td><td>25</td><td>33</td><td>27</td><td>31</td></tr>
                            <tr><td>32</td><td>33</td><td>31</td><td>28</td><td>36</td><td>30</td><td>34</td></tr>
                            <tr><td>35</td><td>36</td><td>34</td><td>33</td><td>1</td><td>31</td><td>3</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        
        <div id="stats-page" class="page-content">
            <h2>ðŸ“Š Archivio e Statistiche Sessioni</h2>
            
            <div class="stats-summary">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>SALDO TOTALE</th>
                            <th>NUMERO EVENTI</th>
                            <th>VITTORIE</th>
                            <th>PERDITE</th>
                            <th>% VITTORIE</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body">
                        <tr>
                            <td id="total-saldo">â‚¬ 0.00</td>
                            <td id="total-events">0</td>
                            <td id="total-wins">0</td>
                            <td id="total-losses">0</td>
                            <td id="win-percentage">0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="button-group" style="justify-content: center;">
                <button id="back-to-main" class="btn btn-blue">Torna alla Pagina Principale</button>
                <button id="reset-archivio" class="btn btn-red">Reset Archivio Statistiche</button>
            </div>
            
            <div class="stats-sessions">
                <h3>Dettaglio Sessioni Archiviate</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Data/Ora</th>
                            <th>Saldo Registrato</th>
                            <th>Step Vittoria</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-body">
                        </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <script>
        // ===============================================
        // VARIABILI GLOBALI e STRUTTURE DATI
        // ===============================================
        const inputEstratto = document.getElementById('numero-estratto');
        const valoreUnitarioInput = document.getElementById('valore-unitario');
        const listaEstratti = document.getElementById('lista-estratti');
        const saldoRealTime = document.getElementById('saldo-real-time');
        const btnResetNumeri = document.getElementById('reset-numeri');
        const btnResetProgressione = document.getElementById('reset-progressione');
        const btnArchiviaSaldo = document.getElementById('archivia-saldo');
        const btnVisualizzaArchivio = document.getElementById('visualizza-archivio');
        const btnRichiamaUltimi = document.getElementById('richiama-ultimi'); 
        
        const mainPage = document.getElementById('main-page');
        const statsPage = document.getElementById('stats-page');
        const progressionBody = document.getElementById('progression-body');
        const tabellaDatiElemento = document.getElementById('tabella-dati');
        const suggestedNumbersElement = document.getElementById('numeri-suggeriti');
        const righeTabella = tabellaDatiElemento.querySelectorAll('tbody tr');
        
        const TABELLA_DATI = [
            [2, 1, 3, 36, 4, 34, 6], [5, 4, 6, 1, 9, 3, 7], [8, 9, 7, 4, 12, 6, 10],
            [11, 12, 10, 9, 13, 7, 15], [14, 13, 15, 12, 16, 10, 18], [17, 16, 18, 13, 21, 15, 19],
            [20, 21, 19, 16, 24, 18, 22], [23, 24, 22, 21, 25, 19, 27], [26, 25, 27, 24, 28, 22, 30],
            [29, 28, 30, 25, 33, 27, 31], [32, 33, 31, 28, 36, 30, 34], [35, 36, 34, 33, 1, 31, 3]
        ];
        const MEDI_PER_RIGA = {
            0: [1, 3], 1: [4, 6], 2: [9, 7], 3: [12, 10], 4: [13, 15], 5: [16, 18], 
            6: [21, 19], 7: [24, 22], 8: [25, 27], 9: [28, 30], 10: [33, 31], 11: [36, 34]
        };

        const PROGRESSION_MULTIPLIERS = [
            { BIG: 4, MEDI: 2, MINI: 1 }, { BIG: 4, MEDI: 2, MINI: 1 }, { BIG: 4, MEDI: 2, MINI: 1 },
            { BIG: 6, MEDI: 4, MINI: 1 }, { BIG: 6, MEDI: 4, MINI: 2 }, { BIG: 10, MEDI: 8, MINI: 4 },
            { BIG: 8, MEDI: 4, MINI: 0 }, // Step 7: I MINI non sono piÃ¹ puntati (moltiplicatore 0)
            { BIG: 8, MEDI: 5, MINI: 0 }, 
            { BIG: 10, MEDI: 5, MINI: 0 },
            { BIG: 10, MEDI: 6, MINI: 0 }, 
            { BIG: 12, MEDI: 8, MINI: 0 }, 
            { BIG: 12, MEDI: 8, MINI: 0 },
            { BIG: 8, MEDI: 8, MINI: 0 }, 
            { BIG: 9, MEDI: 9, MINI: 0 }, 
            { BIG: 10, MEDI: 10, MINI: 0 },
            { BIG: 11, MEDI: 11, MINI: 0 }, 
            { BIG: 12, MEDI: 12, MINI: 0 }, 
            { BIG: 12, MEDI: 12, MINI: 0 },
            { BIG: 13, MEDI: 13, MINI: 0 }, 
            { BIG: 15, MEDI: 15, MINI: 0 } 
        ];

        // STATO GLOBALE PAGINA PRINCIPALE
        let numeriEstratti = [];
        let righeBruciate = new Array(12).fill(false);
        let mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set()); 
        let isBettingPhase = false; 
        let suggestedNumbers = null; 
        let currentStep = 0; 
        let currentSaldo = 0; 
        let winStepForArchive = null; 
        
        // STATO GLOBALE ARCHIVIO
        let sessionArchives = []; 

        // ===============================================
        // FUNZIONI UTILITY E DI GIOCO
        // ===============================================
        const formatCurrency = (value) => `â‚¬ ${value.toFixed(2).replace('.', ',')}`;
        
        function getUnitValue() {
             const value = valoreUnitarioInput.value.replace(',', '.');
             return parseFloat(value) || 0;
        }

        function calculateStake(step, unitValue) {
            if (step < 1 || step > 20) return null;
            const mult = PROGRESSION_MULTIPLIERS[step - 1];
            
            const bigBet = mult.BIG * unitValue;
            const medioBet = mult.MEDI * unitValue;
            const miniBet = mult.MINI * unitValue;
            
            const totalStake = bigBet + (2 * medioBet) + (4 * miniBet);

            return { bigBet, medioBet, miniBet, totalStake };
        }

        function initializeProgressionTable() {
            progressionBody.innerHTML = '';
            
            const unitValue = getUnitValue() || 0.10; 
            
            if (!valoreUnitarioInput.value || getUnitValue() <= 0) {
                 valoreUnitarioInput.value = unitValue.toFixed(2).replace('.', ',');
            }
            
            PROGRESSION_MULTIPLIERS.forEach((mult, index) => {
                const step = index + 1;
                const riga = progressionBody.insertRow();
                riga.id = `step-row-${step}`;
                
                const bigBet = mult.BIG * unitValue;
                const medioBet = mult.MEDI * unitValue;
                const miniBet = mult.MINI * unitValue;

                riga.innerHTML = `
                    <td>STEP ${step}</td>
                    <td>${formatCurrency(bigBet)}</td>
                    <td>${formatCurrency(medioBet)}</td>
                    <td>${formatCurrency(medioBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                `;
            });
            if (currentStep > 0) {
                 highlightStep(currentStep);
            }
        }
        
        function highlightStep(newStep) {
            if (currentStep >= 1 && currentStep <= 20) {
                const prevRow = document.getElementById(`step-row-${currentStep}`);
                if (prevRow) prevRow.classList.remove('active-step');
            }
            
            if (newStep >= 1 && newStep <= 20) {
                const newRow = document.getElementById(`step-row-${newStep}`);
                if (newRow) newRow.classList.add('active-step');
            }
            currentStep = newStep;
        }

        function updateProgressionHeader(numbers) {
            document.getElementById('big-number').textContent = numbers[0] || '?';
            document.getElementById('medio1-number').textContent = numbers[1] || '?';
            document.getElementById('medio2-number').textContent = numbers[2] || '?';
            
            // Regola: Nascondi i MINI nell'intestazione se Step >= 7
            const miniDisplay = (isBettingPhase && currentStep >= 7) ? 'â€”' : (numbers[3] || '?');
            document.getElementById('mini1-number').textContent = miniDisplay;
            document.getElementById('mini2-number').textContent = miniDisplay;
            document.getElementById('mini3-number').textContent = miniDisplay;
            document.getElementById('mini4-number').textContent = miniDisplay;
        }
        
        function updateEstrattiList() {
            listaEstratti.innerHTML = ''; 
            const maxDisplay = 30; 
            numeriEstratti.slice(0, maxDisplay).forEach(numero => {
                const row = listaEstratti.insertRow();
                const cell = row.insertCell();
                cell.textContent = numero;
            });
        }
        
        function updateSuggestedNumbers(numbers) {
            if (numbers && numbers.length > 0) {
                
                let numbersToDisplay = [...numbers];

                // Regola: Mostra solo i 3 numeri se siamo in fase di scommessa e lo step Ã¨ 7 o superiore
                if (isBettingPhase && currentStep >= 7) {
                    numbersToDisplay = [numbers[0], numbers[1], numbers[2]];
                }
                
                suggestedNumbersElement.innerHTML = `<strong>${numbersToDisplay.join(', ')}</strong>`;
            } else {
                suggestedNumbersElement.textContent = 'Attendendo la Logica...';
            }
        }

        function checkIfRowBruciata(rigaIndex, numeroEstratto) {
            if (righeBruciate[rigaIndex]) return; 

            const datiRiga = TABELLA_DATI[rigaIndex];
            if (datiRiga[0] === numeroEstratto) {
                righeBruciate[rigaIndex] = true;
                righeTabella[rigaIndex].classList.add('riga-bruciata');
                return;
            }

            const numeriMedi = MEDI_PER_RIGA[rigaIndex];
            if (numeriMedi.includes(numeroEstratto)) {
                mediUscitiPerRiga[rigaIndex].add(numeroEstratto);
                
                if (mediUscitiPerRiga[rigaIndex].size === 2) {
                    righeBruciate[rigaIndex] = true;
                    righeTabella[rigaIndex].classList.add('riga-bruciata');
                }
            }
        }
        
        function updateSaldoLoss() {
             const unitValue = getUnitValue(); 
             const currentStake = calculateStake(currentStep, unitValue);

             if (currentStake) {
                currentSaldo -= currentStake.totalStake;
                saldoRealTime.textContent = formatCurrency(currentSaldo);
             }
        }
        
        function triggerBettingPhase(rigaIndex, rigaDati) {
            const unitValue = getUnitValue();
            if (unitValue <= 0) {
                 alert('ATTENZIONE: Inserisci prima un "Valore Unitario â‚¬" valido per iniziare la progressione.');
                 isBettingPhase = false;
                 suggestedNumbers = null;
                 return;
            }

            isBettingPhase = true;
            suggestedNumbers = rigaDati;
            
            updateProgressionHeader(rigaDati); 
            updateSuggestedNumbers(rigaDati);
            
            highlightStep(1);
            updateSaldoLoss(); // PRIMA perdita (Step 1)
            
            const numeri = rigaDati.join(', ');
            alert(`CI SIAMO! I 7 numeri da giocare sono: ${numeri}`);
            
            checkRichiamaUltimiButtonState(); 
        }

        function processBettingPhase(numeroEstratto) {
            const unitValue = getUnitValue();
            const currentStake = calculateStake(currentStep, unitValue);
            
            if (!currentStake) return;

            let isWin = false;
            let winIndex = -1;
            
            // Regola: Se Step >= 7, consideriamo solo i primi 3 numeri (BIG e 2 MEDI)
            let checkNumbers = suggestedNumbers;
            if (currentStep >= 7) {
                checkNumbers = suggestedNumbers.slice(0, 3);
            }
            
            if (checkNumbers.includes(numeroEstratto)) {
                 isWin = true;
                 winIndex = suggestedNumbers.indexOf(numeroEstratto);
            }

            if (isWin) {
                let betOnWinNumber = 0;
                
                // Determina la puntata specifica sul numero vincente
                if (winIndex === 0) { 
                    betOnWinNumber = currentStake.bigBet;
                } else if (winIndex === 1 || winIndex === 2) { 
                    betOnWinNumber = currentStake.medioBet;
                } else if (winIndex >= 3 && currentStep <= 6) { 
                    // I MINI numeri sono giocati solo fino allo step 6 
                    betOnWinNumber = currentStake.miniBet;
                } 
                
                const winLord = betOnWinNumber * 36;
                currentSaldo += winLord;
                
                saldoRealTime.textContent = formatCurrency(currentSaldo);
                winStepForArchive = currentStep; 
                
                // MESSAGGIO DI VINCITA AGGIORNATO
                alert(`HAI VINTO ${formatCurrency(winLord)}! Il saldo Real Time aggiornato Ã¨ ${formatCurrency(currentSaldo)}. Archivia la sessione.`);
                
                // Disabilita l'input per forzare l'archiviazione e PRESERVA LO STATO
                inputEstratto.disabled = true; 

            } else {
                if (currentStep < 20) {
                    currentStep++;
                    highlightStep(currentStep);
                    updateSaldoLoss(); 
                    
                    updateSuggestedNumbers(suggestedNumbers); 
                    updateProgressionHeader(suggestedNumbers || []); 

                } else {
                    alert("Progressione terminata all'ultimo Step (20). Resetta per iniziare una nuova giocata.");
                    resetProgressionState();
                }
            }
            checkRichiamaUltimiButtonState();
        }
        
        function tracciaNumeroPreGame(numero, analyzeOnly = false) {
             let winTriggered = false;

            TABELLA_DATI.forEach((rigaDati, rigaIndex) => {
                if (winTriggered) return; 

                rigaDati.forEach((valore, colonnaIndex) => {
                    if (valore === numero) {
                        const rigaElemento = righeTabella[rigaIndex];
                        const cella = rigaElemento.cells[colonnaIndex];
                        
                        let nuovaEvidenziazione = false;
                        if (!righeBruciate[rigaIndex]) {
                            if (!cella.classList.contains('evidenziato')) {
                                cella.classList.add('evidenziato'); 
                                nuovaEvidenziazione = true;
                            }
                        }
                        
                        if (!righeBruciate[rigaIndex] && nuovaEvidenziazione) {
                            const evidenziateNellaRiga = rigaElemento.querySelectorAll('.evidenziato').length;

                            if (evidenziateNellaRiga === 4) { 
                                if (!analyzeOnly) { 
                                    triggerBettingPhase(rigaIndex, rigaDati);
                                }
                                winTriggered = true;
                                return; 
                            }
                        }
                        
                        if (!righeBruciate[rigaIndex]) {
                            checkIfRowBruciata(rigaIndex, numero);
                        }
                    }
                });
            });
        }
        
        function resetProgressionState() {
            isBettingPhase = false;
            suggestedNumbers = null;
            currentStep = 0;
            winStepForArchive = null; 
            
            highlightStep(0); 
            updateProgressionHeader(['?', '?', '?', '?', '?', '?', '?']); 
            updateSuggestedNumbers(null); 
        }

        function resetAllMainData() {
            numeriEstratti = [];
            currentSaldo = 0; 
            saldoRealTime.textContent = formatCurrency(currentSaldo);
            
            if (!valoreUnitarioInput.value || getUnitValue() <= 0) {
                 valoreUnitarioInput.value = '0,10'; 
            }
            
            resetProgressionState(); 
            righeBruciate = new Array(12).fill(false);
            mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set());
            
            righeTabella.forEach(riga => {
                riga.classList.remove('riga-bruciata');
            });
            tabellaDatiElemento.querySelectorAll('.evidenziato').forEach(cell => {
                cell.classList.remove('evidenziato');
            });
            
            updateEstrattiList();
            initializeProgressionTable(); 
            inputEstratto.focus();
            inputEstratto.disabled = false; 
            
            checkRichiamaUltimiButtonState();
        }

        function analyzeExtractedNumbers(numbers) {
            righeBruciate = new Array(12).fill(false);
            mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set()); 
            tabellaDatiElemento.querySelectorAll('.evidenziato, .riga-bruciata').forEach(el => {
                el.classList.remove('evidenziato', 'riga-bruciata');
            });
            
            numbers.slice().reverse().forEach(numero => {
                tracciaNumeroPreGame(numero, true); 
            });
            
            updateEstrattiList(); 
            checkRichiamaUltimiButtonState();
        }

        // ===============================================
        // GESTIONE ARCHIVIO E LOCAL STORAGE
        // ===============================================
        
        function loadArchives() {
            const data = localStorage.getItem('vegas7_stats_archive');
            if (data) sessionArchives = JSON.parse(data);
            else sessionArchives = [];
        }
        function saveArchives() {
            localStorage.setItem('vegas7_stats_archive', JSON.stringify(sessionArchives));
        }
        function loadLastExtractedNumbers() {
            const data = localStorage.getItem('vegas7_last_10_numbers');
            return data ? JSON.parse(data) : [];
        }
        function saveLastExtractedNumbers() {
            const last10 = numeriEstratti.slice(0, 10);
            localStorage.setItem('vegas7_last_10_numbers', JSON.stringify(last10));
        }

        function archiveCurrentSaldo() {
            const timestamp = new Date().toLocaleString('it-IT', { 
                day: '2-digit', month: '2-digit', year: 'numeric', 
                hour: '2-digit', minute: '2-digit', second: '2-digit' 
            });
            
            const newEntry = { 
                timestamp: timestamp, 
                saldo: currentSaldo,
                winStep: currentSaldo > 0 ? winStepForArchive : null 
            };
            sessionArchives.unshift(newEntry);
            saveArchives();
            
            saveLastExtractedNumbers(); 
            resetAllMainData(); 
            
            alert(`Saldo Corrente di ${formatCurrency(currentSaldo)} archiviato con successo. Il gioco Ã¨ stato resettato.`);
        }
        
        function checkRichiamaUltimiButtonState() {
            const lastNumbers = loadLastExtractedNumbers();
            const shouldBeDisabled = isBettingPhase || numeriEstratti.length > 0 || lastNumbers.length === 0;
            btnRichiamaUltimi.disabled = shouldBeDisabled;
        }
        
        function updateStatsTables() {
            let totalSaldo = 0;
            let totalEvents = sessionArchives.length;
            let totalWins = 0;
            let totalLosses = 0;
            
            const sessionsBody = document.getElementById('sessions-body');
            sessionsBody.innerHTML = '';

            sessionArchives.forEach(entry => {
                totalSaldo += entry.saldo;
                if (entry.saldo > 0) { totalWins++; } else if (entry.saldo < 0) { totalLosses++; }

                const riga = sessionsBody.insertRow();
                const saldoClass = entry.saldo >= 0 ? 'positive-saldo' : 'negative-saldo';
                const stepDisplay = entry.winStep ? `Step ${entry.winStep}` : 'â€”';
                
                riga.innerHTML = `
                    <td>${entry.timestamp}</td>
                    <td class="${saldoClass}">${formatCurrency(entry.saldo)}</td>
                    <td>${stepDisplay}</td>
                `;
            });
            
            let winPercentage = 0;
            if (totalEvents > 0) {
                winPercentage = ((totalWins / totalEvents) * 100).toFixed(1);
            }

            document.getElementById('total-saldo').textContent = formatCurrency(totalSaldo);
            document.getElementById('total-events').textContent = totalEvents;
            document.getElementById('total-wins').textContent = totalWins;
            document.getElementById('total-losses').textContent = totalLosses;
            document.getElementById('win-percentage').textContent = `${winPercentage}%`;
            
            const totalSaldoCell = document.getElementById('total-saldo');
            totalSaldoCell.classList.remove('positive-saldo', 'negative-saldo');
            if (totalSaldo > 0) totalSaldoCell.classList.add('positive-saldo');
            if (totalSaldo < 0) totalSaldoCell.classList.add('negative-saldo');
        }
        
        function resetStatsArchive() {
            if (confirm("Sei sicuro di voler resettare TUTTO l'archivio delle statistiche?")) {
                sessionArchives = [];
                localStorage.removeItem('vegas7_stats_archive');
                localStorage.removeItem('vegas7_last_10_numbers'); 
                updateStatsTables();
                checkRichiamaUltimiButtonState(); 
                alert('Archivio statistiche resettato con successo.');
            }
        }
        
        function displayStatsPage() {
            loadArchives(); 
            updateStatsTables();
            document.getElementById('back-to-main').addEventListener('click', () => { 
                statsPage.style.display = 'none';
                mainPage.style.display = 'block';
                checkRichiamaUltimiButtonState(); 
            });
            document.getElementById('reset-archivio').addEventListener('click', resetStatsArchive);

            mainPage.style.display = 'none';
            statsPage.style.display = 'block';
        }


        // ===============================================
        // INIZIALIZZAZIONE & LISTENER
        // ===============================================

        window.onload = () => {
            valoreUnitarioInput.value = '0,10'; 
            initializeProgressionTable(); 
            loadArchives(); 
            checkRichiamaUltimiButtonState(); 
            
            // Re-assegna i listener ai pulsanti dell'archivio (se non sono stati giÃ  fatti in modo fisso)
            document.getElementById('visualizza-archivio').addEventListener('click', displayStatsPage); 
            document.getElementById('archivia-saldo').addEventListener('click', archiveCurrentSaldo); 
        };

        // Listener Principale (Input Numero Estratto)
        inputEstratto.addEventListener('change', (event) => {
            const valoreInput = event.target.value;
            if (valoreInput === '') return; 
            const numero = parseInt(valoreInput);
            
            if (numero >= 0 && numero <= 36) {
                numeriEstratti.unshift(numero); 
                updateEstrattiList();
                
                if (isBettingPhase) {
                    processBettingPhase(numero);
                } else {
                    tracciaNumeroPreGame(numero, false); 
                }

                event.target.value = '';
                event.target.focus();
                
                checkRichiamaUltimiButtonState();
            } else {
                alert('Inserisci un numero valido tra 0 e 36.');
                event.target.value = '';
                event.target.focus();
            }
        });
        
        // Listener per l'aggiornamento della tabella di progressione quando cambia il Valore Unitario
        valoreUnitarioInput.addEventListener('input', () => {
             initializeProgressionTable();
        });
        
        btnResetProgressione.addEventListener('click', () => {
             if (confirm("Sei sicuro di voler resettare la progressione di puntate (tornare allo stato pre-gioco)?")) {
                resetProgressionState();
                alert('Progressione resettata. In attesa di una nuova riga vincente.');
                checkRichiamaUltimiButtonState();
             }
        });

        // Listener Reset Numeri (Completo)
        btnResetNumeri.addEventListener('click', () => {
            if(confirm("Sei sicuro di voler resettare tutti i dati (numeri estratti, bruciature, fase di gioco e saldo) della pagina principale?")) {
                resetAllMainData();
                alert('Tutti i dati della pagina principale sono stati resettati.');
            }
        });
        
        // Listener Richiama Ultimi
        btnRichiamaUltimi.addEventListener('click', () => {
            const lastNumbers = loadLastExtractedNumbers();
            if (lastNumbers.length > 0) {
                resetAllMainData();
                numeriEstratti = lastNumbers;
                analyzeExtractedNumbers(numeriEstratti);
                alert(`Caricati ${lastNumbers.length} numeri dalla sessione precedente.`);
            } else {
                alert('Nessun numero precedente salvato da richiamare.');
            }
        });
        
        // I listener per Visualizza Archivio, Archivia Saldo, Back to Main e Reset Archivio
        // sono stati gestiti in modo fisso in window.onload e displayStatsPage per garantire la persistenza.
    </script>

</body>
</html>
