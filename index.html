<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VEGAS 7 NUMBERS</title>
    <style>
        /* CSS per la ReattivitÃ  e lo Stile */
        :root {
            --green-bg: #4CAF50;
            --light-gray-bg: #f0f0f0;
            --red-btn: #f44336;
            --blue-btn: #2196F3;
            --text-color: #333;
            --border-color: #ccc;
            --light-green: #e8ffe8;
            --win-green: #2ecc71;
            --dark-blue: #34495e;
            --disabled-color: #95a5a6;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--green-bg);
            color: var(--text-color);
        }

        /* STILE INTESTAZIONE IMMAGINE */
        .header-image-container {
            text-align: center;
            padding: 10px 0;
            margin: 0;
        }
        .header-image-container img {
            max-width: 100%; /* Rende l'immagine responsiva */
            height: auto;
            max-height: 100px; /* Limita l'altezza per non occupare troppo spazio */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Gestione delle Pagine */
        .page-content {
            display: none;
        }
        #main-page {
            display: block;
        }
        
        /* Area Input Principale */
        .input-area {
            background-color: var(--light-gray-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Campi di Input */
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-group label {
            font-weight: bold;
            flex-basis: 100%;
        }
        .input-group input[type="number"],
        .input-group .calculated-field {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            flex-grow: 1;
            min-width: 120px;
        }
        .input-group .calculated-field {
            background-color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            min-height: 40px;
        }

        /* Bottoni */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: space-around;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
            max-width: 200px;
            transition: background-color 0.3s;
        }
        .btn-red { background-color: var(--red-btn); }
        .btn-blue { background-color: var(--blue-btn); }
        .btn:hover:not(:disabled) { opacity: 0.9; }

        .btn-archive-action {
            background-color: var(--dark-blue);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
        }
        .btn-archive-action:disabled {
            background-color: var(--disabled-color);
            cursor: not-allowed;
        }

        .data-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
        }
        .extracted-numbers-container, .suggested-numbers-area {
            flex: 1 1 200px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .suggested-numbers-area { text-align: center; }
        #numeri-suggeriti {
            font-size: 1.8em;
            color: var(--win-green);
            margin: 10px 0 0;
            word-wrap: break-word;
        }
        .extracted-numbers-table { width: 100%; border-collapse: collapse; }
        .extracted-numbers-table th, .extracted-numbers-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }

        .data-table-container {
            flex: 3 1 400px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { border: 1px solid #000; padding: 8px 5px; text-align: center; font-size: 0.9em; }
        .data-table th { background-color: #e0e0e0; }

        .evidenziato { background-color: #ffffa8 !important; color: #333; font-weight: bold; }
        .riga-bruciata { background-color: #ff4d4d !important; color: white; font-weight: bold; }
        .riga-bruciata td { background-color: transparent !important; color: white; }

        .progression-section {
            background-color: white;
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        .progression-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        .progression-table th, .progression-table td {
            border: 1px solid #000;
            padding: 6px 4px;
            text-align: center;
        }
        .progression-table thead th {
            background-color: #333;
            color: white;
            font-size: 0.9em;
        }
        .header-big { background-color: #555 !important; }
        .header-medio { background-color: #e67e22 !important; }
        .header-mini { background-color: #27ae60 !important; }

        .active-step {
            background-color: var(--light-green) !important;
            font-weight: bold;
        }
        .reset-progression-btn {
            background-color: var(--dark-blue);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* STILI PAGINA STATISTICHE (RIDUZIONE FONT/PADDING) */
        #stats-page {
            background-color: var(--light-gray-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .stats-summary, .stats-sessions {
            margin-bottom: 20px;
        }
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .stats-table th, .stats-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: center;
        }
        .stats-table th {
            background-color: #ddd;
        }
        .positive-saldo { color: var(--win-green); font-weight: bold; }
        .negative-saldo { color: var(--red-btn); font-weight: bold; }

        /* Media Query per schermi grandi */
        @media (min-width: 600px) {
            .input-group label { flex-basis: auto; margin-right: 10px; }
            .input-group { justify-content: space-between; }
            .input-group input[type="number"], .input-group .calculated-field { flex-grow: 0; width: calc(33% - 15px); }
            .action-buttons button { max-width: 200px; }
        }
    </style>
</head>
<body>

    <div class="header-image-container">
        <img src="https://raw.githubusercontent.com/mauro8274/Provavegas/81a5c6465ecb5ed1ef903dcc9d2ddeff69d04964/IMG_0628.jpeg" alt="Logo Vegas 7 Numbers">
    </div>

    <div class="container">
        
        <div id="main-page" class="page-content">
            
            <div class="input-area">
                
                <div class="input-group">
                    <label for="numero-estratto">Numero Estratto (0-36):</label>
                    <input type="number" id="numero-estratto" min="0" max="36" inputmode="numeric" pattern="[0-9]*" placeholder="Inserisci numero" autofocus>
                    
                    <label for="valore-unitario">Valore Unitario (â‚¬):</label>
                    <input type="text" id="valore-unitario" placeholder="0,10"> <label>Saldo Real Time:</label>
                    <div id="saldo-real-time" class="calculated-field">â‚¬ 0.00</div>
                </div>

                <div class="button-group">
                    <button id="reset-numeri" class="btn btn-red">Reset numeri</button>
                    <button id="visualizza-archivio" class="btn btn-blue">Visualizza archivio</button>
                </div>
                
                <div class="action-buttons">
                    <button id="archivia-saldo" class="btn-archive-action">Archivia Saldo Corrente</button>
                    <button id="richiama-ultimi" class="btn-archive-action" disabled>Richiama Ultimi 10 Numeri</button>
                </div>
            </div>
            
            <hr>

            <div class="suggested-numbers-area">
                <h3>I Numeri Suggeriti:</h3>
                <p id="numeri-suggeriti">Attendendo la Logica...</p>
            </div>

            <hr>

            <div class="progression-section">
                <h3>PROGRESSIONE PUNTATE</h3>
                <table class="progression-table">
                    <thead>
                        <tr id="progression-header">
                            <th>STEP</th>
                            <th class="header-big">BIG: <span id="big-number">?</span></th>
                            <th class="header-medio">MEDIO: <span id="medio1-number">?</span></th>
                            <th class="header-medio">MEDIO: <span id="medio2-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini1-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini2-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini3-number">?</span></th>
                            <th class="header-mini">MINI: <span id="mini4-number">?</span></th>
                        </tr>
                    </thead>
                    <tbody id="progression-body">
                        </tbody>
                </table>
                <button id="reset-progressione" class="reset-progression-btn">RESET PROGRESSIONE</button>
            </div>

            <hr>

            <div class="data-section">
                
                <div class="extracted-numbers-container">
                    <h3>Numeri Estratti</h3>
                    <table class="extracted-numbers-table">
                        <thead><tr><th>Numero</th></tr></thead>
                        <tbody id="lista-estratti"></tbody>
                    </table>
                </div>

                <div class="data-table-container">
                    <h3>TABELLA DATI</h3>
                    <table class="data-table" id="tabella-dati">
                        <tbody>
                            <tr><td>2</td><td>1</td><td>3</td><td>36</td><td>4</td><td>34</td><td>6</td></tr>
                            <tr><td>5</td><td>4</td><td>6</td><td>1</td><td>9</td><td>3</td><td>7</td></tr>
                            <tr><td>8</td><td>9</td><td>7</td><td>4</td><td>12</td><td>6</td><td>10</td></tr>
                            <tr><td>11</td><td>12</td><td>10</td><td>9</td><td>13</td><td>7</td><td>15</td></tr>
                            <tr><td>14</td><td>13</td><td>15</td><td>12</td><td>16</td><td>10</td><td>18</td></tr>
                            <tr><td>17</td><td>16</td><td>18</td><td>13</td><td>21</td><td>15</td><td>19</td></tr>
                            <tr><td>20</td><td>21</td><td>19</td><td>16</td><td>24</td><td>18</td><td>22</td></tr>
                            <tr><td>23</td><td>24</td><td>22</td><td>21</td><td>25</td><td>19</td><td>27</td></tr>
                            <tr><td>26</td><td>25</td><td>27</td><td>24</td><td>28</td><td>22</td><td>30</td></tr>
                            <tr><td>29</td><td>28</td><td>30</td><td>25</td><td>33</td><td>27</td><td>31</td></tr>
                            <tr><td>32</td><td>33</td><td>31</td><td>28</td><td>36</td><td>30</td><td>34</td></tr>
                            <tr><td>35</td><td>36</td><td>34</td><td>33</td><td>1</td><td>31</td><td>3</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
        
        <div id="stats-page" class="page-content">
            <h2>ðŸ“Š Archivio e Statistiche Sessioni</h2>
            
            <div class="stats-summary">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>SALDO TOTALE</th>
                            <th>NUMERO EVENTI</th>
                            <th>VITTORIE</th>
                            <th>PERDITE</th>
                            <th>% VITTORIE</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body">
                        <tr>
                            <td id="total-saldo">â‚¬ 0.00</td>
                            <td id="total-events">0</td>
                            <td id="total-wins">0</td>
                            <td id="total-losses">0</td>
                            <td id="win-percentage">0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="button-group" style="justify-content: center;">
                <button id="back-to-main" class="btn btn-blue">Torna alla Pagina Principale</button>
                <button id="reset-archivio" class="btn btn-red">Reset Archivio Statistiche</button>
            </div>
            
            <div class="stats-sessions">
                <h3>Dettaglio Sessioni Archiviate</h3>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>Data/Ora</th>
                            <th>Saldo Registrato</th>
                            <th>Step Vittoria</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-body">
                        </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <script>
        // ===============================================
        // *** CONFIGURAZIONE JSONBIN.IO ***
        // ===============================================
        const JSONBIN_ACCESS_KEY = '$2a$10$jyfQtGxraAzGJat.A7ksZ.Z4RQ2Tjzx3YvAwd7Ro.seCzFmfE3PyC';
        const JSONBIN_BIN_ID = '69395cce43b1c97be9e44dcc';
        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

        const JSONBIN_HEADERS = {
            'X-ACCESS-KEY': JSONBIN_ACCESS_KEY,
            'Content-Type': 'application/json',
            // Per il recupero si puÃ² usare anche solo la X-ACCESS-KEY
        };

        // ===============================================
        // VARIABILI GLOBALI e STRUTTURE DATI
        // ===============================================
        const inputEstratto = document.getElementById('numero-estratto');
        const valoreUnitarioInput = document.getElementById('valore-unitario');
        const listaEstratti = document.getElementById('lista-estratti');
        const saldoRealTime = document.getElementById('saldo-real-time');
        const btnResetNumeri = document.getElementById('reset-numeri');
        const btnResetProgressione = document.getElementById('reset-progressione');
        const btnArchiviaSaldo = document.getElementById('archivia-saldo');
        const btnVisualizzaArchivio = document.getElementById('visualizza-archivio');
        const btnRichiamaUltimi = document.getElementById('richiama-ultimi');
        
        const mainPage = document.getElementById('main-page');
        const statsPage = document.getElementById('stats-page');
        const progressionBody = document.getElementById('progression-body');
        const tabellaDatiElemento = document.getElementById('tabella-dati');
        const suggestedNumbersElement = document.getElementById('numeri-suggeriti');
        const righeTabella = tabellaDatiElemento.querySelectorAll('tbody tr');
        
        const TABELLA_DATI = [
            [2, 1, 3, 36, 4, 34, 6], [5, 4, 6, 1, 9, 3, 7], [8, 9, 7, 4, 12, 6, 10],
            [11, 12, 10, 9, 13, 7, 15], [14, 13, 15, 12, 16, 10, 18], [17, 16, 18, 13, 21, 15, 19],
            [20, 21, 19, 16, 24, 18, 22], [23, 24, 22, 21, 25, 19, 27], [26, 25, 27, 24, 28, 22, 30],
            [29, 28, 30, 25, 33, 27, 31], [32, 33, 31, 28, 36, 30, 34], [35, 36, 34, 33, 1, 31, 3]
        ];
        const MEDI_PER_RIGA = {
            0: [1, 3], 1: [4, 6], 2: [9, 7], 3: [12, 10], 4: [13, 15], 5: [16, 18],
            6: [21, 19], 7: [24, 22], 8: [25, 27], 9: [28, 30], 10: [33, 31], 11: [36, 34]
        };

        const PROGRESSION_MULTIPLIERS = [
            { BIG: 4, MEDI: 2, MINI: 1 }, { BIG: 4, MEDI: 2, MINI: 1 }, { BIG: 4, MEDI: 2, MINI: 1 },
            { BIG: 6, MEDI: 4, MINI: 1 }, { BIG: 6, MEDI: 4, MINI: 2 }, { BIG: 10, MEDI: 8, MINI: 4 },
            { BIG: 8, MEDI: 4, MINI: 0 }, // Step 7: I MINI non sono piÃ¹ puntati (moltiplicatore 0)
            { BIG: 8, MEDI: 5, MINI: 0 },
            { BIG: 10, MEDI: 5, MINI: 0 },
            { BIG: 10, MEDI: 6, MINI: 0 },
            { BIG: 12, MEDI: 8, MINI: 0 },
            { BIG: 12, MEDI: 8, MINI: 0 },
            { BIG: 8, MEDI: 8, MINI: 0 },
            { BIG: 9, MEDI: 9, MINI: 0 },
            { BIG: 10, MEDI: 10, MINI: 0 },
            { BIG: 11, MEDI: 11, MINI: 0 },
            { BIG: 12, MEDI: 12, MINI: 0 },
            { BIG: 12, MEDI: 12, MINI: 0 },
            { BIG: 13, MEDI: 13, MINI: 0 },
            { BIG: 15, MEDI: 15, MINI: 0 }
        ];

        // STATO GLOBALE PAGINA PRINCIPALE
        let numeriEstratti = [];
        let righeBruciate = new Array(12).fill(false);
        let mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set());
        let isBettingPhase = false;
        let suggestedNumbers = null;
        let currentStep = 0;
        let currentSaldo = 0;
        let winStepForArchive = null;
        
        // STATO GLOBALE ARCHIVIO (Caricato da remoto)
        let sessionArchives = [];


        // ===============================================
        // *** FUNZIONI DI GESTIONE JSONBIN.IO (API) ***
        // ===============================================

        /**
         * Recupera l'archivio delle sessioni da jsonbin.io.
         * @returns {Array} L'array delle sessioni archiviate o un array vuoto.
         */
        async function fetchArchivesFromRemote() {
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'GET',
                    headers: {
                        'X-ACCESS-KEY': JSONBIN_ACCESS_KEY
                    }
                });

                if (!response.ok) {
                    // Controlla il caso di bin vuoto o appena creato che potrebbe dare 404
                    if (response.status === 404) return []; 
                    throw new Error(`Errore HTTP nel recupero: ${response.status}`);
                }

                const result = await response.json();
        
                // Verifica esplicita che 'record' esista e sia un Array.
                if (result && Array.isArray(result.record)) {
                    // DEBUG: Controlla che il dato estratto sia corretto
                    console.log("Dati estratti dal record:", result.record); 
                    return result.record;
                } else {
                    console.warn('Il record remoto non Ã¨ un array o Ã¨ assente nel corpo della risposta:', result);
                    // Ritorna array vuoto se il formato non Ã¨ quello atteso (es. JSONBin Ã¨ vuoto e restituisce solo {})
                    return []; 
                }

            } catch (error) {
                // *** CORREZIONE CRITICA: Blocco catch completo e con return ***
                console.error('Errore durante il recupero remoto dell\'archivio:', error); 
                alert('ATTENZIONE: Errore nel caricamento dell\'archivio remoto. VerrÃ  mostrato un archivio vuoto.');     
                return []; // Ritorna un array vuoto per non bloccare il resto del codice
            }
        }

        /**
         * Salva (sovrascrive) l'intero archivio delle sessioni su jsonbin.io.
         * @param {Array} archives - L'array completo da salvare.
         */
        async function saveArchivesToRemote(archives) {
            try {
                const payload = JSON.stringify({ record: archives });
                console.log('Invio payload a JSONBin:', payload); // LOG CRITICO

                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT', // PUT sovrascrive il contenuto
                    headers: JSONBIN_HEADERS,
                    // Inserisce l'array (o l'oggetto vuoto per reset) nel wrapper 'record'
                    body: payload 
                });

                if (!response.ok) {
                    const errorDetail = await response.text();
                    throw new Error(`Errore HTTP nel salvataggio: ${response.status}. Dettagli: ${errorDetail}`);
                }

                console.log('Archivio salvato con successo su jsonbin.io.');
                return true;

            } catch (error) {
                console.error('Errore durante il salvataggio remoto dell\'archivio:', error);
                alert('ERRORE CRITICO: Impossibile salvare l\'archivio su jsonbin.io. I dati non saranno persistenti.');
                return false;
            }
        }


        // ===============================================
        // FUNZIONI UTILITY E DI GIOCO
        // ===============================================
        const formatCurrency = (value) => `â‚¬ ${value.toFixed(2).replace('.', ',')}`;
        
        function getUnitValue() {
             const value = valoreUnitarioInput.value.replace(',', '.');
             return parseFloat(value) || 0;
        }

        function calculateStake(step, unitValue) {
            if (step < 1 || step > 20) return null;
            const mult = PROGRESSION_MULTIPLIERS[step - 1];
            
            const bigBet = mult.BIG * unitValue;
            const medioBet = mult.MEDI * unitValue;
            const miniBet = mult.MINI * unitValue;

            const totalStake = bigBet + (2 * medioBet) + (4 * miniBet);

            return { bigBet, medioBet, miniBet, totalStake };
        }

        function initializeProgressionTable() {
            progressionBody.innerHTML = '';
            
            const unitValue = getUnitValue() || 0.10;
            
            if (!valoreUnitarioInput.value || getUnitValue() <= 0) {
                 valoreUnitarioInput.value = unitValue.toFixed(2).replace('.', ',');
            }
            
            PROGRESSION_MULTIPLIERS.forEach((mult, index) => {
                const step = index + 1;
                const riga = progressionBody.insertRow();
                riga.id = `step-row-${step}`;
                
                const bigBet = mult.BIG * unitValue;
                const medioBet = mult.MEDI * unitValue;
                const miniBet = mult.MINI * unitValue;

                riga.innerHTML = `
                    <td>STEP ${step}</td>
                    <td>${formatCurrency(bigBet)}</td>
                    <td>${formatCurrency(medioBet)}</td>
                    <td>${formatCurrency(medioBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                    <td>${formatCurrency(miniBet)}</td>
                `;
            });
            if (currentStep > 0) {
                 highlightStep(currentStep);
            }
        }
        
        function highlightStep(newStep) {
            if (currentStep >= 1 && currentStep <= 20) {
                const prevRow = document.getElementById(`step-row-${currentStep}`);
                if (prevRow) prevRow.classList.remove('active-step');
            }
            
            if (newStep >= 1 && newStep <= 20) {
                const newRow = document.getElementById(`step-row-${newStep}`);
                if (newRow) newRow.classList.add('active-step');
            }
            currentStep = newStep;
        }

        function updateProgressionHeader(numbers) {
            document.getElementById('big-number').textContent = numbers[0] || '?';
            document.getElementById('medio1-number').textContent = numbers[1] || '?';
            document.getElementById('medio2-number').textContent = numbers[2] || '?';
            
            // Regola: Nascondi i MINI nell'intestazione se Step >= 7
            const miniDisplay = (isBettingPhase && currentStep >= 7) ? 'â€”' : (numbers[3] || '?');
            document.getElementById('mini1-number').textContent = miniDisplay;
            document.getElementById('mini2-number').textContent = miniDisplay;
            document.getElementById('mini3-number').textContent = miniDisplay;
            document.getElementById('mini4-number').textContent = miniDisplay;
        }
        
        function updateEstrattiList() {
            listaEstratti.innerHTML = '';
            const maxDisplay = 30;
            numeriEstratti.slice(0, maxDisplay).forEach(numero => {
                const row = listaEstratti.insertRow();
                const cell = row.insertCell();
                cell.textContent = numero;
            });
        }
        
        function updateSuggestedNumbers(numbers) {
            if (numbers && numbers.length > 0) {
                
                let numbersToDisplay = [...numbers];

                // Regola: Mostra solo i 3 numeri se siamo in fase di scommessa e lo step Ã¨ 7 o superiore
                if (isBettingPhase && currentStep >= 7) {
                    numbersToDisplay = [numbers[0], numbers[1], numbers[2]];
                }
                
                suggestedNumbersElement.innerHTML = `<strong>${numbersToDisplay.join(', ')}</strong>`;
            } else {
                suggestedNumbersElement.textContent = 'Attendendo la Logica...';
            }
        }

        function checkIfRowBruciata(rigaIndex, numeroEstratto) {
            if (righeBruciate[rigaIndex]) return;

            const datiRiga = TABELLA_DATI[rigaIndex];
            if (datiRiga[0] === numeroEstratto) {
                righeBruciate[rigaIndex] = true;
                righeTabella[rigaIndex].classList.add('riga-bruciata');
                return;
            }

            const numeriMedi = MEDI_PER_RIGA[rigaIndex];
            if (numeriMedi.includes(numeroEstratto)) {
                mediUscitiPerRiga[rigaIndex].add(numeroEstratto);
                
                if (mediUscitiPerRiga[rigaIndex].size === 2) {
                    righeBruciate[rigaIndex] = true;
                    righeTabella[rigaIndex].classList.add('riga-bruciata');
                }
            }
        }
        
        function updateSaldoLoss() {
             const unitValue = getUnitValue();
             const currentStake = calculateStake(currentStep, unitValue);

             if (currentStake) {
                currentSaldo -= currentStake.totalStake;
                saldoRealTime.textContent = formatCurrency(currentSaldo);
             }
        }
        
        function triggerBettingPhase(rigaIndex, rigaDati) {
            const unitValue = getUnitValue();
            if (unitValue <= 0) {
                 alert('ATTENZIONE: Inserisci prima un "Valore Unitario â‚¬" valido per iniziare la progressione.');
                 isBettingPhase = false;
                 suggestedNumbers = null;
                 return;
            }

            isBettingPhase = true;
            suggestedNumbers = rigaDati;
            
            updateProgressionHeader(rigaDati);
            updateSuggestedNumbers(rigaDati);
            
            highlightStep(1);
            updateSaldoLoss(); // PRIMA perdita (Step 1)
            
            const numeri = rigaDati.join(', ');
            alert(`CI SIAMO! I 7 numeri da giocare sono: ${numeri}`);
            
            checkRichiamaUltimiButtonState();
        }

        function processBettingPhase(numeroEstratto) {
            const unitValue = getUnitValue();
            const currentStake = calculateStake(currentStep, unitValue);
            
            if (!currentStake) return;

            let isWin = false;
            let winIndex = -1;
            
            // Regola: Se Step >= 7, consideriamo solo i primi 3 numeri (BIG e 2 MEDI)
            let checkNumbers = suggestedNumbers;
            if (currentStep >= 7) {
                checkNumbers = suggestedNumbers.slice(0, 3);
            }
            
            if (checkNumbers.includes(numeroEstratto)) {
                 isWin = true;
                 winIndex = suggestedNumbers.indexOf(numeroEstratto);
            }

            if (isWin) {
                let betOnWinNumber = 0;
                
                // Determina la puntata specifica sul numero vincente
                if (winIndex === 0) {
                    betOnWinNumber = currentStake.bigBet;
                } else if (winIndex === 1 || winIndex === 2) {
                    betOnWinNumber = currentStake.medioBet;
                } else if (winIndex >= 3 && currentStep <= 6) {
                    // I MINI numeri sono giocati solo fino allo step 6
                    betOnWinNumber = currentStake.miniBet;
                }
                
                const winLord = betOnWinNumber * 36;
                currentSaldo += winLord;
                
                saldoRealTime.textContent = formatCurrency(currentSaldo);
                winStepForArchive = currentStep;
                
                // MESSAGGIO DI VINCITA AGGIORNATO
                alert(`HAI VINTO ${formatCurrency(winLord)}! Il saldo Real Time aggiornato Ã¨ ${formatCurrency(currentSaldo)}. Archivia la sessione.`);
                
                // Disabilita l'input per forzare l'archiviazione e PRESERVA LO STATO
                inputEstratto.disabled = true;

            } else {
                if (currentStep < 20) {
                    currentStep++;
                    highlightStep(currentStep);
                    updateSaldoLoss();
                    
                    updateSuggestedNumbers(suggestedNumbers);
                    updateProgressionHeader(suggestedNumbers || []);

                } else {
                    alert("Progressione terminata all'ultimo Step (20). Resetta per iniziare una nuova giocata.");
                    resetProgressionState();
                }
            }
            checkRichiamaUltimiButtonState();
        }
        
        function tracciaNumeroPreGame(numero, analyzeOnly = false) {
             let winTriggered = false;

             TABELLA_DATI.forEach((rigaDati, rigaIndex) => {
                 if (winTriggered) return;

                 rigaDati.forEach((valore, colonnaIndex) => {
                     if (valore === numero) {
                         const rigaElemento = righeTabella[rigaIndex];
                         const cella = rigaElemento.cells[colonnaIndex];
                         
                         let nuovaEvidenziazione = false;
                         if (!righeBruciate[rigaIndex]) {
                             if (!cella.classList.contains('evidenziato')) {
                                 cella.classList.add('evidenziato');
                                 nuovaEvidenziazione = true;
                             }
                         }
                         
                         if (!righeBruciate[rigaIndex] && nuovaEvidenziazione) {
                             const evidenziateNellaRiga = rigaElemento.querySelectorAll('.evidenziato').length;

                             if (evidenziateNellaRiga === 4) {
                                 if (!analyzeOnly) {
                                     triggerBettingPhase(rigaIndex, rigaDati);
                                 }
                                 winTriggered = true;
                                 return;
                             }
                         }
                         
                         if (!righeBruciate[rigaIndex]) {
                             checkIfRowBruciata(rigaIndex, numero);
                         }
                     }
                 });
             });
        }
        
        function resetProgressionState() {
            isBettingPhase = false;
            suggestedNumbers = null;
            currentStep = 0;
            winStepForArchive = null;
            
            highlightStep(0);
            updateProgressionHeader(['?', '?', '?', '?', '?', '?', '?']);
            updateSuggestedNumbers(null);
        }

        function resetAllMainData() {
            numeriEstratti = [];
            currentSaldo = 0;
            saldoRealTime.textContent = formatCurrency(currentSaldo);
            
            if (!valoreUnitarioInput.value || getUnitValue() <= 0) {
                 valoreUnitarioInput.value = '0,10';
            }
            
            resetProgressionState();
            righeBruciate = new Array(12).fill(false);
            mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set());
            
            righeTabella.forEach(riga => {
                riga.classList.remove('riga-bruciata');
            });
            tabellaDatiElemento.querySelectorAll('.evidenziato').forEach(cell => {
                cell.classList.remove('evidenziato');
            });
            
            updateEstrattiList();
            initializeProgressionTable();
            inputEstratto.focus();
            inputEstratto.disabled = false;
            
            checkRichiamaUltimiButtonState();
        }

        function analyzeExtractedNumbers(numbers) {
            righeBruciate = new Array(12).fill(false);
            mediUscitiPerRiga = new Array(12).fill(0).map(() => new Set());
            tabellaDatiElemento.querySelectorAll('.evidenziato, .riga-bruciata').forEach(el => {
                el.classList.remove('evidenziato', 'riga-bruciata');
            });
            
            // Analizza i numeri in ordine inverso (dal piÃ¹ recente al piÃ¹ vecchio)
            numbers.slice().reverse().forEach(numero => {
                tracciaNumeroPreGame(numero, true);
            });
            
            updateEstrattiList();
            checkRichiamaUltimiButtonState();
        }

        // ===============================================
        // LOGICA PAGINA ARCHIVIO (CORRETTA)
        // ===============================================

        function updateStatsTables() {
            let totalSaldo = 0;
            let totalEvents = sessionArchives.length;
            let totalWins = 0;
            let totalLosses = 0;
            
            const sessionsBody = document.getElementById('sessions-body');
            sessionsBody.innerHTML = '';

            // Itera l'archivio per calcolare le statistiche e renderizzare la tabella
            sessionArchives.forEach(entry => {
                
                // Forzare il saldo a un numero valido
                const saldoValue = Number(entry.saldo);
                
                if (!isNaN(saldoValue)) {
                    totalSaldo += saldoValue;
                } else {
                     console.warn("Dato Saldo corrotto rilevato nel database:", entry.saldo);
                }

                // Conteggio di Vittorie e Perdite
                if (entry.winStep) { 
                    totalWins++; 
                } else { 
                    totalLosses++; 
                }

                // Render della Riga Sessione
                const riga = sessionsBody.insertRow();
                const saldoClass = saldoValue >= 0 ? 'positive-saldo' : 'negative-saldo';
                const winStepText = entry.winStep ? `Vittoria @ Step ${entry.winStep}` : 'PERDITA / Reset';
                
                riga.innerHTML = `
                    <td>${entry.timestamp}</td>
                    <td class="${saldoClass}">${formatCurrency(saldoValue)}</td>
                    <td>${winStepText}</td>
                `;
            });
            
            // 4. Calcolo della Percentuale
            let winPercentage = 0;
            if (totalEvents > 0) {
                winPercentage = ((totalWins / totalEvents) * 100).toFixed(1);
            }

            // 5. Aggiornamento del Riepilogo (Summary)
            const totalSaldoCell = document.getElementById('total-saldo');
            
            totalSaldoCell.textContent = formatCurrency(totalSaldo);
            totalSaldoCell.classList.remove('positive-saldo', 'negative-saldo');
            if (totalSaldo > 0) totalSaldoCell.classList.add('positive-saldo');
            if (totalSaldo < 0) totalSaldoCell.classList.add('negative-saldo');
            
            document.getElementById('total-events').textContent = totalEvents;
            document.getElementById('total-wins').textContent = totalWins;
            document.getElementById('total-losses').textContent = totalLosses;
            document.getElementById('win-percentage').textContent = `${winPercentage}%`;
        }
        
        async function updateArchivePage() {
            // 1. Forza il recupero dei dati freschi dal server
            const fetchedArchives = await fetchArchivesFromRemote(); 

            // 2. Se i dati sono validi, aggiorna l'archivio locale.
            if (Array.isArray(fetchedArchives)) {
                sessionArchives = fetchedArchives;
            } else {
                sessionArchives = [];
            }
            
            // 3. Visualizza e calcola le statistiche
            updateStatsTables(); 
            checkRichiamaUltimiButtonState();
        }

        // ===============================================
        // GESTIONE EVENTI PRINCIPALE
        // ===============================================

        // 1. Inserimento Numero Estratto
        inputEstratto.addEventListener('change', (e) => {
            let numero = parseInt(e.target.value);
            e.target.value = ''; // Pulisce l'input

            if (isNaN(numero) || numero < 0 || numero > 36) {
                alert('Inserisci un numero valido tra 0 e 36.');
                return;
            }

            // Aggiunge il numero all'inizio dell'array
            numeriEstratti.unshift(numero);
            
            if (isBettingPhase) {
                processBettingPhase(numero);
            } else {
                tracciaNumeroPreGame(numero);
            }

            updateEstrattiList();
            checkRichiamaUltimiButtonState();
        });

        // 2. Click su "Reset numeri" (Reset Main Data)
        btnResetNumeri.addEventListener('click', resetAllMainData);

        // 3. Click su "Reset Progressione"
        btnResetProgressione.addEventListener('click', () => {
             // Archivia la perdita se il gioco era in corso
             if (isBettingPhase && currentSaldo < 0 && winStepForArchive === null) {
                const confirmReset = confirm("Sei sicuro di voler resettare la progressione? Questa sessione verrÃ  archiviata come PERDITA (Step Max non raggiunto).");
                if (confirmReset) {
                    archiveCurrentSession(false); // Archivia come perdita
                    resetAllMainData(); // Resetta lo stato dopo l'archiviazione
                }
             } else if (isBettingPhase) {
                 // Caso in cui si Ã¨ in progressione ma si Ã¨ in pareggio o guadagno (non dovrebbe accadere se si Ã¨ in progressione di perdita)
                 resetProgressionState();
                 alert("Progressione resettata.");
             } else {
                 resetProgressionState();
                 alert("Progressione resettata.");
             }
        });

        // 4. Click su "Archivia Saldo Corrente" (Archiviazione su jsonbin.io)
        btnArchiviaSaldo.addEventListener('click', async () => {
            const isWin = winStepForArchive !== null;
            if (isWin) {
                await archiveCurrentSession(true, winStepForArchive);
                resetAllMainData(); // Resetta lo stato dopo l'archiviazione di una vincita
            } else {
                alert('Puoi archiviare solo dopo una VINCITA o per un RESET di perdita forzato (usa il pulsante "RESET PROGRESSIONE").');
            }
        });

        /**
         * Funzione per archiviare la sessione corrente in modo remoto.
         * @param {boolean} isWin - Indica se la sessione si Ã¨ conclusa con una vincita.
         * @param {number|null} winStep - Lo step di progressione in cui c'Ã¨ stata la vittoria (o null).
         */
        async function archiveCurrentSession(isWin, winStep = null) {
            const newArchive = {
                timestamp: new Date().toLocaleString('it-IT'),
                saldo: currentSaldo, // Salviamo il saldo come numero
                winStep: isWin ? winStep : null
            };

            // 1. Recupera l'archivio remoto corrente
            let currentArchives = await fetchArchivesFromRemote();
            
            // 2. Aggiunge la nuova sessione
            currentArchives.push(newArchive);
            
            // 3. Salva l'archivio aggiornato su jsonbin.io
            const success = await saveArchivesToRemote(currentArchives);

            if (success) {
                sessionArchives = currentArchives; // Aggiorna lo stato locale dopo il salvataggio remoto
                alert(`Sessione archiviata con successo! Saldo: ${formatCurrency(currentSaldo)}.`);
            }
            
            // Riabilita l'input dopo l'archiviazione (se disabilitato per la vittoria)
            inputEstratto.disabled = false;
        }

        // 5. Click su "Visualizza archivio"
        btnVisualizzaArchivio.addEventListener('click', () => {
            mainPage.style.display = 'none';
            statsPage.style.display = 'block';
            updateArchivePage();
        });

        // 6. Click su "Torna alla Pagina Principale"
        document.getElementById('back-to-main').addEventListener('click', () => {
            statsPage.style.display = 'none';
            mainPage.style.display = 'block';
            inputEstratto.focus();
        });

        // 7. Click su "Reset Archivio Statistiche" (Reset Archivio Remoto)
        document.getElementById('reset-archivio').addEventListener('click', async () => {
            const confirmReset = confirm("Sei sicuro di voler ELIMINARE PERMANENTEMENTE TUTTO l'archivio delle statistiche? Questa azione Ã¨ irreversibile e cancellerÃ  i dati su jsonbin.io.");
            if (confirmReset) {
                console.log("Tentativo di invio array vuoto: [] per correggere il formato remoto."); // LOG CRITICO
                // CORRETTO: Passiamo un array vuoto [], che viene correttamente wrappato in {"record": []}
                const success = await saveArchivesToRemote([]); 
                if (success) {
                    alert('Archivio statistiche eliminato con successo!');
                    updateArchivePage();
                }
            }
        });

        // 8. Click su "Richiama Ultimi 10 Numeri"
        btnRichiamaUltimi.addEventListener('click', async () => {
            if (numeriEstratti.length === 0) {
                 alert("Nessun numero estratto in locale da richiamare.");
                 return;
            }

            // Richiama gli ultimi 10 numeri estratti
            const ultimi10 = numeriEstratti.slice(0, 10);
            
            // Aggiorna lo stato locale come se questi 10 numeri fossero appena estratti
            numeriEstratti = [];
            resetAllMainData(); // Resetta lo stato del gioco (lascia il saldo a 0)

            // Inserisce i numeri uno ad uno per rifare l'analisi
            ultimi10.reverse().forEach(numero => {
                numeriEstratti.unshift(numero);
            });

            analyzeExtractedNumbers(numeriEstratti);
            alert(`Richiamati gli ultimi ${ultimi10.length} numeri estratti per l'analisi.`);
        });
        
        function checkRichiamaUltimiButtonState() {
             // Il pulsante Richiama Ultimi 10 Ã¨ abilitato solo se ci sono almeno 10 numeri estratti
             btnRichiamaUltimi.disabled = numeriEstratti.length < 10 || isBettingPhase || winStepForArchive !== null;
        }


        // 9. Aggiornamento Tabella Progressioni quando cambia il Valore Unitario
        valoreUnitarioInput.addEventListener('change', initializeProgressionTable);


        // ===============================================
        // INIZIALIZZAZIONE
        // ===============================================

        async function init() {
            initializeProgressionTable();
            // Carica l'archivio remoto all'avvio per riempire l'array sessionArchives (non lo visualizza ancora)
            sessionArchives = await fetchArchivesFromRemote(); 
            // Aggiorna la visualizzazione del saldo (parte da 0.00)
            saldoRealTime.textContent = formatCurrency(currentSaldo);
            inputEstratto.focus();
        }

        init();
    </script>
</body>
</html>
